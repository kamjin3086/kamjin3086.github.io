import{_ as Et}from"./preload-helper.BlTxHScW.js";document.addEventListener("DOMContentLoaded",()=>{const H=document.getElementById("upload-section"),tt=document.getElementById("imageInput"),bt=document.getElementById("editor-section"),R=document.getElementById("image-preview-wrapper"),l=document.getElementById("previewCanvas"),O=l.getContext("2d"),y=document.getElementById("widthInput"),f=document.getElementById("heightInput"),et=document.getElementById("aspectRatioLock"),nt=document.getElementById("presetsSelect"),It=document.querySelectorAll(".quick-scale-btn"),z=document.getElementById("cropBtn"),S=document.getElementById("formatSelect"),ot=document.getElementById("quality-control"),V=document.getElementById("qualitySlider"),$=document.getElementById("qualityValue"),at=document.getElementById("bitdepth-control"),it=document.getElementById("bitDepthSelect"),Y=document.getElementById("downloadBtn"),G=document.getElementById("downloadLink"),Bt=document.getElementById("resetBtn"),N=document.getElementById("loading-spinner"),St=document.getElementById("theme-toggle"),Ct=document.getElementById("theme-icon-light"),Mt=document.getElementById("theme-icon-dark"),A=document.getElementById("custom-modal"),st=document.querySelector("#custom-modal > div"),q=document.getElementById("modal-message"),x=document.getElementById("modal-actions"),Tt=document.getElementById("info-bar"),rt=document.getElementById("info-filename"),lt=document.getElementById("info-original-dims"),dt=document.getElementById("info-original-size"),ct=document.getElementById("info-current-dims"),gt=document.querySelectorAll(".tab-btn"),Dt=document.querySelectorAll(".tab-panel"),mt=document.getElementById("history-section"),U=document.getElementById("history-list"),C=document.getElementById("clear-history-btn"),ut=document.getElementById("crop-overlay"),c=document.getElementById("crop-box"),g=document.getElementById("dynamic-tooltip"),W=document.getElementById("dynamic-tooltip-content"),ht=document.getElementById("replace-image-btn"),j=document.getElementById("bgRemoveBtn"),E=document.getElementById("bgRemoveStatus");let b=null,r=new Image,m=new Image,J=null,I=1,F=!1,p=[];const Ht=(t,e)=>{let n;return(...o)=>{clearTimeout(n),n=setTimeout(()=>t(...o),e)}};function Rt(t,e=2){if(t===0)return"0 Bytes";const n=1024,o=e<0?0:e,a=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(t)/Math.log(n));return parseFloat((t/Math.pow(n,i)).toFixed(o))+" "+a[i]}function $t(){const t=new Date,e=String(t.getFullYear()).slice(-2),n=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0"),a=String(t.getHours()).padStart(2,"0"),i=String(t.getMinutes()).padStart(2,"0"),s=String(t.getSeconds()).padStart(2,"0");return`${e}${n}${o}-${a}${i}${s}`}function pt(t){document.documentElement.classList.toggle("dark",t==="dark"),Ct?.classList.toggle("hidden",t==="dark"),Mt?.classList.toggle("hidden",t!=="dark")}St?.addEventListener("click",()=>{const t=document.documentElement.classList.contains("dark")?"light":"dark";localStorage.setItem("theme",t),pt(t)}),pt(localStorage.getItem("theme")||"light");function yt(){A?.classList.remove("hidden"),setTimeout(()=>{A?.classList.remove("opacity-0"),st?.classList.remove("scale-95")},10)}function X(){A?.classList.add("opacity-0"),st?.classList.add("scale-95"),setTimeout(()=>A?.classList.add("hidden"),300)}function M(t){q&&(q.textContent=t),x&&(x.innerHTML="");const e=document.createElement("button");e.textContent="好的",e.className="w-full swiss-btn py-2 px-4",e.onclick=X,x?.appendChild(e),yt()}function Nt(t,e){q&&(q.textContent=t),x&&(x.innerHTML="");const n=document.createElement("button");n.textContent="确认",n.className="w-1/2 bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors",n.onclick=()=>{X(),e()};const o=document.createElement("button");o.textContent="取消",o.className="w-1/2 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors",o.onclick=X,x?.appendChild(o),x?.appendChild(n),yt()}gt.forEach(t=>{const e=()=>ft(t.dataset.tab);t.addEventListener("mouseenter",e),t.addEventListener("click",e,{passive:!0})});function ft(t){gt.forEach(e=>{const n=e.dataset.tab===t;e.classList.toggle("border-gray-900",n),e.classList.toggle("dark:border-gray-100",n),e.classList.toggle("text-gray-900",n),e.classList.toggle("dark:text-gray-100",n),e.classList.toggle("border-transparent",!n),e.classList.toggle("text-gray-500",!n)}),Dt.forEach(e=>e.classList.toggle("hidden",e.id!==`${t}-panel`)),ut?.classList.toggle("hidden",t!=="crop")}function At(){b&&(Tt?.classList.remove("hidden"),rt&&(rt.textContent=b.name),lt&&(lt.textContent=`${r.width}x${r.height}`),dt&&(dt.textContent=Rt(b.size)),ct&&(ct.textContent=`${Math.round(m.width)}x${Math.round(m.height)}`))}["dragover","dragleave","drop"].forEach(t=>{H?.addEventListener(t,e=>{e.preventDefault(),e.stopPropagation(),t==="dragover"&&H.classList.add("border-gray-900","dark:border-gray-500"),t!=="dragover"&&H.classList.remove("border-gray-900","dark:border-gray-500"),t==="drop"&&e.dataTransfer?.files.length&&vt(e.dataTransfer.files[0])})}),tt?.addEventListener("change",t=>t.target.files?.length&&vt(t.target.files[0])),ht?.addEventListener("click",()=>tt?.click());function vt(t){if(!t.type.startsWith("image/")){M("请上传有效的图片文件!");return}b=t;const e=new FileReader;e.onload=n=>{r.src=n.target.result,J=n.target.result,r.onload=()=>{I=r.width/r.height,wt(),H?.classList.add("hidden"),bt?.classList.remove("hidden"),ht?.classList.remove("hidden"),Ft()}},e.readAsDataURL(t)}function P(t,e){const n=t.tagName==="CANVAS"?t.toDataURL():t.src;m.src=n,m.onerror=()=>M("加载处理后的图片时出错。"),m.onload=()=>{l.width=m.width,l.height=m.height,O.clearRect(0,0,l.width,l.height),O.drawImage(m,0,0),_t(),qt(),At()}}function wt(){J&&(r=new Image,r.src=J,r.onload=()=>{I=r.width/r.height,P(r)},nt.value="")}Bt?.addEventListener("click",wt);function qt(){y.value=Math.round(m.width).toString(),f.value=Math.round(m.height).toString()}const Lt=Ht(()=>{_(parseInt(y.value),parseInt(f.value))},400);y?.addEventListener("input",()=>{if(et.checked){const t=parseInt(y.value,10);isNaN(t)||(f.value=Math.round(t/I).toString())}Lt()}),f?.addEventListener("input",()=>{if(et.checked){const t=parseInt(f.value,10);isNaN(t)||(y.value=Math.round(t*I).toString())}Lt()});function _(t,e){if(isNaN(t)||isNaN(e)||t<=0||e<=0)return;const n=document.createElement("canvas");n.width=t,n.height=e,n.getContext("2d").drawImage(r,0,0,t,e),P(n)}It.forEach(t=>{t.addEventListener("click",()=>{const e=parseFloat(t.dataset.scale),n=Math.round(l.width*e),o=Math.round(l.height*e);y.value=n.toString(),f.value=o.toString(),_(n,o)})}),nt?.addEventListener("change",t=>{if(!t.target.value)return;const[e,n]=t.target.value.split("x").map(Number);y.value=e.toString(),f.value=n.toString(),_(e,n),t.target.value=""});let v={x:0,y:0};ut?.addEventListener("mousedown",t=>{t.preventDefault(),F=!0,c.style.display="block";const e=R.getBoundingClientRect();v.x=t.clientX-e.left,v.y=t.clientY-e.top,c.style.left=v.x+"px",c.style.top=v.y+"px",c.style.width="0px",c.style.height="0px"}),window.addEventListener("mousemove",t=>{if(!F)return;t.preventDefault();const e=R.getBoundingClientRect();let n=t.clientX-e.left,o=t.clientY-e.top;n=Math.max(0,Math.min(n,e.width)),o=Math.max(0,Math.min(o,e.height));const a=Math.min(v.x,n),i=Math.min(v.y,o),s=Math.abs(v.x-n),u=Math.abs(v.y-o);c.style.left=a+"px",c.style.top=i+"px",c.style.width=s+"px",c.style.height=u+"px"}),window.addEventListener("mouseup",()=>{if(!F)return;F=!1;const t=parseFloat(c.style.width),e=parseFloat(c.style.height);z.disabled=t<5||e<5}),z?.addEventListener("click",()=>{const t=l.getBoundingClientRect(),e=c.getBoundingClientRect();if(e.width<=0||e.height<=0)return;const n=m.width/t.width,o=(e.left-t.left)*n,a=(e.top-t.top)*n,i=e.width*n,s=e.height*n;if(i<=0||s<=0||isNaN(o)||isNaN(a)){M("裁剪尺寸无效，请重新拖动选区。"),console.error("Invalid crop dimensions calculated:",{sx:o,sy:a,sWidth:i,sHeight:s});return}const u=document.createElement("canvas");u.width=i,u.height=s,u.getContext("2d").drawImage(m,o,a,i,s,0,0,i,s),P(u),c.style.width="0px",c.style.height="0px",c.style.display="none",z.disabled=!0,r=new Image,r.src=u.toDataURL(),r.onload=()=>{I=r.width/r.height}}),S?.addEventListener("change",()=>{const t=S.value==="image/png";ot&&(ot.style.display=t?"none":"block"),at&&(at.style.display=t?"block":"none"),j?.classList.toggle("hidden",!t)}),V?.addEventListener("input",t=>{$&&($.textContent=t.target.value)}),Y?.addEventListener("click",async()=>{N?.classList.remove("hidden"),Y.disabled=!0;const t=S.value,e=parseInt(V.value,10),n=it?it.value:"32";let o=l;if(t==="image/png"&&n==="24"){const k=document.createElement("canvas");k.width=l.width,k.height=l.height;const w=k.getContext("2d");w.fillStyle="#ffffff",w.fillRect(0,0,k.width,k.height),w.drawImage(l,0,0),o=k}let a="";if(t==="image/png")if(n==="24"){const w=o.getContext("2d").getImageData(0,0,o.width,o.height).data,L=new Uint8Array(o.width*o.height*3);for(let d=0,h=0;d<w.length;d+=4,h+=3)L[h]=w[d],L[h+1]=w[d+1],L[h+2]=w[d+2];let T;const B=window.UPNG;if(!window.pako)try{const d=await Et(()=>import("./pako.esm.CMINtMsn.js"),[]);window.pako=d.default??d}catch(d){console.error("加载 pako 失败，PNG 24bit 可能无法正确编码",d)}if(B&&typeof B.encodeLL=="function")T=B.encodeLL([L.buffer],o.width,o.height,3,0,8);else if(B&&typeof B.encode=="function"){const d=new Uint8Array(o.width*o.height*4);for(let h=0,D=0;D<L.length;h+=4,D+=3)d[h]=L[D],d[h+1]=L[D+1],d[h+2]=L[D+2],d[h+3]=255;T=B.encode([d.buffer],o.width,o.height,0)}else console.warn("UPNG.js 未加载，使用 Canvas 直接导出 PNG"),a=o.toDataURL("image/png"),T=null;if(T){const d=new Blob([T],{type:"image/png"});a=URL.createObjectURL(d)}}else a=o.toDataURL(t,e/100);else a=o.toDataURL(t,e/100);const i=$t(),s=`${l.width}x${l.height}`,u=b.name.split(".").slice(0,-1).join("."),Z=t.split("/")[1],kt=`${u}-edited-${i}-${s}.${Z}`;G.href=a,G.download=kt,G.click();const Ot={source:{filename:b.name,originalDims:`${r.width}x${r.height}`},output:{finalDims:`${l.width}x${l.height}`,format:t,quality:t!=="image/png"?e:"N/A",bitDepth:t==="image/png"?n:"N/A"}};Ut({id:Date.now(),filename:kt,timestamp:new Date().toLocaleString(),dataUrl:a,settings:Ot}),N?.classList.add("hidden"),Y.disabled=!1}),j?.addEventListener("click",async()=>{N?.classList.remove("hidden"),j.disabled=!0,E?.querySelector("span")?.remove(),E?.classList.remove("hidden"),E&&(E.innerHTML=`
              <svg class="animate-spin h-4 w-4 mr-2 text-gray-500 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>
              <span>去背景处理中</span><span class="loading-dot"></span><span class="loading-dot"></span><span class="loading-dot"></span>`);try{const t=await new Promise(i=>{l.toBlob(s=>{i(new File([s],"preview.png",{type:"image/png"}))},"image/png")}),e=i=>{i.isFirstDownload&&E?.classList.remove("hidden")},{removeBackground:n}=await Et(async()=>{const{removeBackground:i}=await import("./remove-background.Cr-HPMh_.js");return{removeBackground:i}},[]),o=await n(t,{threshold:128},e),a=new Image;a.src=o,a.onload=()=>{r=a,m=a,I=a.width/a.height,P(a)}}catch(t){console.error(t),M("去背景失败，请稍后再试")}finally{N?.classList.add("hidden"),j.disabled=!1,E?.classList.add("hidden")}});function Ut(t){p.unshift(t),p.length>20&&p.pop(),jt(),K()}function jt(){localStorage.setItem("imageToolkitHistory",JSON.stringify(p))}function Ft(){const t=localStorage.getItem("imageToolkitHistory");t&&(p=JSON.parse(t),K())}function K(){U&&(U.innerHTML=""),p.length>0?(mt?.classList.remove("hidden"),C&&(C.disabled=!1),p.forEach(t=>{const e=document.createElement("div");e.className="flex items-center justify-between p-2 rounded-lg bg-gray-100 dark:bg-gray-900/50",e.innerHTML=`
                    <div class="flex items-center gap-3 overflow-hidden">
                        <img src="${t.dataUrl}" class="w-10 h-10 object-cover rounded-md flex-shrink-0">
                        <div class="truncate">
                            <p class="text-sm font-medium truncate">${t.filename}</p>
                            <p class="text-xs text-gray-500">${t.timestamp}</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <button class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 flex-shrink-0" data-tooltip="应用此参数" data-settings-id="${t.id}">
                            <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="pointer-events: none;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path><path d="M14.121 5.879l-2.121 2.121-1.414-1.414"></path></svg>
                        </button>
                        <a href="${t.dataUrl}" download="${t.filename}" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 flex-shrink-0" data-tooltip="重新下载">
                            <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="pointer-events: none;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        </a>
                    </div>
                `,e.addEventListener("mouseenter",n=>Pt(n,t)),e.addEventListener("mouseleave",()=>{Q=setTimeout(xt,300)}),U?.appendChild(e)})):(mt?.classList.add("hidden"),C&&(C.disabled=!0))}let Q;function Pt(t,e){clearTimeout(Q);const n=JSON.stringify(e.settings,null,2);W&&(W.innerHTML=`
                <pre class="text-xs font-mono">${n}</pre>
                <button class="js-copy-btn absolute top-1 right-1 p-1 rounded-md hover:bg-gray-700" data-tooltip="拷贝JSON">
                    <svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="pointer-events: none;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                </button>
            `);const o=W?.querySelector(".js-copy-btn");o&&(o.onclick=i=>{i.stopPropagation();const s=document.createElement("textarea");s.value=n,s.style.position="fixed",s.style.opacity="0",document.body.appendChild(s),s.focus(),s.select();try{document.execCommand("copy"),o.innerHTML='<svg class="w-4 h-4 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="pointer-events: none;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>'}catch{M("拷贝失败!")}document.body.removeChild(s),setTimeout(()=>{o.innerHTML='<svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="pointer-events: none;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>'},1500)});const a=t.currentTarget.getBoundingClientRect();if(g){g.style.left=`${a.left}px`;let i=a.top-8;g.style.transform="translateY(-100%)",document.body.appendChild(g),g.getBoundingClientRect().top<0&&(i=a.bottom+8,g.style.transform="translateY(0)"),g.style.top=`${i}px`,g.classList.remove("hidden"),setTimeout(()=>g?.classList.add("visible"),10)}}function xt(){g?.classList.remove("visible"),setTimeout(()=>{g?.classList.add("hidden")},200)}g?.addEventListener("mouseenter",()=>clearTimeout(Q)),g?.addEventListener("mouseleave",()=>xt()),U?.addEventListener("click",t=>{const e=t.target.closest("[data-settings-id]");if(!e)return;const n=parseInt(e.dataset.settingsId,10),o=p.find(Z=>Z.id===n);if(!o)return;const{output:a}=o.settings,[i,s]=a.finalDims.split("x").map(Number);y.value=i.toString(),f.value=s.toString(),S.value=a.format,a.quality!=="N/A"&&(V.value=a.quality.toString(),$&&($.textContent=a.quality.toString())),S.dispatchEvent(new Event("change")),_(i,s),ft("resize");const u=e.innerHTML;e.innerHTML='<svg class="w-5 h-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="pointer-events: none;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',e.disabled=!0,setTimeout(()=>{e.innerHTML=u,e.disabled=!1},1500)}),C?.addEventListener("click",()=>{Nt("您确定要清空所有下载历史记录吗？此操作无法撤销。",()=>{p=[],localStorage.removeItem("imageToolkitHistory"),K()})});function _t(){try{const e=O.getImageData(0,0,l.width,l.height).data;let n=!1;for(let o=3;o<e.length;o+=4)if(e[o]<250){n=!0;break}R?.classList.toggle("has-alpha",n)}catch{R?.classList.remove("has-alpha")}}});
