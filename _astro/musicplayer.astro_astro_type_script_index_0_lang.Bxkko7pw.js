const e={playlist:document.getElementById("playlist"),lyrics:document.getElementById("lyrics"),audioPlayer:document.getElementById("audioPlayer"),themeToggle:document.getElementById("checkbox"),themeToggleBtn:document.getElementById("themeToggleBtn"),loadOnlineBtn:document.getElementById("loadOnlineBtn"),fileInput:document.getElementById("fileInput"),fileDropArea:document.getElementById("fileDropArea"),showPlaylistBtn:document.getElementById("showPlaylistBtn"),showLyricsBtn:document.getElementById("showLyricsBtn"),searchInput:document.getElementById("searchInput"),searchBtn:document.getElementById("searchBtn")},c={name:"GD Studio API",baseUrl:"https://music-api.gdstudio.xyz/api.php",getList:async i=>{const n=`${c.baseUrl}?types=search&source=netease,kuwo&name=${encodeURIComponent(i)}&count=100`,t=await fetch(n);if(!t.ok)throw new Error("API request failed");const r=await t.json();if(!Array.isArray(r)||r.length===0)throw new Error("No songs found");return r.map(s=>({id:s.id,name:s.name,artists:[{name:s.artist.join(" / ")}],source:s.source,lyric_id:s.lyric_id}))},getSongUrl:i=>`${c.baseUrl}?types=url&id=${i.id}&source=${i.source||"netease"}&br=320000`,getLyric:i=>`${c.baseUrl}?types=lyric&id=${i.lyric_id||i.id}&source=${i.source||"netease"}`},l={isOnlineMode:!1,audioFiles:[],lyricsFiles:{},onlineSongs:[],currentTrackIndex:-1,currentAudioUrl:null,lyricsData:[],currentLyricLine:-1};window.addEventListener("load",E);e.audioPlayer?.addEventListener("ended",x);e.audioPlayer?.addEventListener("timeupdate",B);function p(i){document.body.classList.toggle("dark-mode",i),localStorage.setItem("theme",i?"dark":"light"),L()}function L(){const i=e.themeToggleBtn;if(!i)return;const n=i.querySelector("i"),t=i.querySelector(".theme-label"),r=document.body.classList.contains("dark-mode");n&&(n.classList.toggle("fa-sun",!r),n.classList.toggle("fa-moon",r)),t&&(t.textContent=r?"暗色":"亮色")}function E(){const i=localStorage.getItem("theme");i&&(document.body.classList.toggle("dark-mode",i==="dark"),e.themeToggle&&(e.themeToggle.checked=i==="dark")),e.themeToggle?.addEventListener("change",n=>{const r=n.target.checked;p(r)}),e.themeToggleBtn?.addEventListener("click",()=>{const n=!document.body.classList.contains("dark-mode");p(n)}),L(),e.loadOnlineBtn?.addEventListener("click",P),e.searchBtn?.addEventListener("click",g),e.searchInput?.addEventListener("keypress",n=>{n.key==="Enter"&&g()}),e.fileInput?.addEventListener("change",n=>{const t=n.target;t.files&&h(t.files)}),e.fileDropArea?.addEventListener("dragover",n=>{n.preventDefault(),e.fileDropArea?.classList.add("dragover")}),e.fileDropArea?.addEventListener("dragleave",()=>e.fileDropArea?.classList.remove("dragover")),e.fileDropArea?.addEventListener("drop",n=>{n.preventDefault(),e.fileDropArea?.classList.remove("dragover"),n.dataTransfer?.files&&h(n.dataTransfer.files)}),e.showPlaylistBtn?.addEventListener("click",()=>d("playlist")),e.showLyricsBtn?.addEventListener("click",()=>d("lyrics"))}async function P(){l.isOnlineMode=!0,window.innerWidth<=768&&d("playlist");const i=e.loadOnlineBtn?.querySelector(".btn-text"),n=e.loadOnlineBtn?.querySelector(".loader");e.loadOnlineBtn&&(e.loadOnlineBtn.disabled=!0),i&&(i.style.display="none"),n&&(n.style.display="inline-block"),e.playlist&&(e.playlist.innerHTML="<div>正在聚合雷达歌单...</div>");try{const t=await c.getList("热门");T(t),l.onlineSongs=t,v(),l.onlineSongs.length>0&&u(0)}catch(t){console.error("加载在线歌曲时发生错误:",t),e.playlist&&(e.playlist.innerHTML="<div>加载失败，API源不可用。</div>")}finally{e.loadOnlineBtn&&(e.loadOnlineBtn.disabled=!1),i&&(i.style.display="inline-block"),n&&(n.style.display="none")}}function g(){const i=(e.searchInput?.value||"").trim();if(!i){e.searchInput?.focus();return}O(i,!1)}async function O(i,n=!1){l.isOnlineMode=!0,window.innerWidth<=768&&d("playlist");const t=e.loadOnlineBtn?.querySelector(".btn-text"),r=e.loadOnlineBtn?.querySelector(".loader");e.loadOnlineBtn&&(e.loadOnlineBtn.disabled=!0),e.searchBtn&&(e.searchBtn.disabled=!0),t&&(t.style.display="none"),r&&(r.style.display="inline-block"),e.playlist&&(e.playlist.innerHTML=`<div>正在加载 "${i}"...</div>`);try{const s=await c.getList(i);n&&T(s),l.onlineSongs=s,v(),l.onlineSongs.length>0&&n&&u(0),l.onlineSongs.length===0&&e.playlist&&(e.playlist.innerHTML=`<div>未能找到关于 "${i}" 的在线歌曲。</div>`)}catch(s){console.error("加载在线歌曲时发生错误:",s),e.playlist&&(e.playlist.innerHTML="<div>加载失败，请检查网络或API源。</div>")}finally{e.loadOnlineBtn&&(e.loadOnlineBtn.disabled=!1),e.searchBtn&&(e.searchBtn.disabled=!1),t&&(t.style.display="inline-block"),r&&(r.style.display="none")}}async function S(i){l.isOnlineMode=!0,l.currentTrackIndex=i,w(),I();const n=l.onlineSongs[i];e.lyrics&&(e.lyrics.innerHTML=`<div>正在加载: ${n.name}</div>`);const t=c.getSongUrl(n),s=(await fetch(t).then(a=>a.json())).url?.replace(/^http:/,"https");if(!s)throw new Error("无效的播放地址");e.audioPlayer&&(e.audioPlayer.src=s,e.audioPlayer.load(),e.audioPlayer.play());try{const a=c.getLyric(n),o=await fetch(a).then(f=>f.json());o.lyric?m(o.lyric):e.lyrics&&(e.lyrics.innerHTML="<div>未找到在线歌词。</div>")}catch{e.lyrics&&(e.lyrics.innerHTML="<div>歌词加载失败。</div>")}}function v(){e.playlist&&(e.playlist.innerHTML=l.onlineSongs.map((i,n)=>`<div id="track-item-${n}" onclick="findAndPlayOnlineSong(${n})">${i.name} - ${i.artists.map(t=>t.name).join("/")}</div>`).join("")||"<div>列表为空</div>")}function d(i){window.innerWidth>768||(i==="playlist"?(e.showPlaylistBtn?.classList.add("active"),e.showLyricsBtn?.classList.remove("active"),e.playlist?.classList.remove("mobile-hidden"),e.lyrics?.classList.add("mobile-hidden")):(e.showPlaylistBtn?.classList.remove("active"),e.showLyricsBtn?.classList.add("active"),e.playlist?.classList.add("mobile-hidden"),e.lyrics?.classList.remove("mobile-hidden")))}window.playPrevious=function(){if(l.currentTrackIndex<=0)return;const n=l.currentTrackIndex-1;l.isOnlineMode?u(n):y(n)};window.playNext=function(){const n=l.isOnlineMode?l.onlineSongs.length:l.audioFiles.length;if(l.currentTrackIndex>=n-1){e.lyrics&&(e.lyrics.innerHTML="<div>已是列表最后一首。</div>");return}const t=l.currentTrackIndex+1;l.isOnlineMode?u(t):y(t)};function x(){window.playNext()}function h(i){if(i.length===0)return;l.isOnlineMode=!1,window.innerWidth<=768&&d("playlist");let n=!1;for(const t of Array.from(i)){const r=t.name.split(".").pop()?.toLowerCase(),s=t.name.split(".").slice(0,-1).join(".");r&&["mp3","wav","ogg","m4a","flac","aac","wma"].includes(r)?l.audioFiles.some(a=>a.name===t.name)||(l.audioFiles.push(t),n=!0):r&&["lrc","txt"].includes(r)&&(l.lyricsFiles[s]=t)}n&&A(),l.audioFiles.length>0&&e.audioPlayer?.paused&&y(0)}function y(i){if(i<0||i>=l.audioFiles.length)return;l.currentAudioUrl&&URL.revokeObjectURL(l.currentAudioUrl),l.isOnlineMode=!1,l.currentTrackIndex=i,w();const n=l.audioFiles[i];l.currentAudioUrl=URL.createObjectURL(n),e.audioPlayer&&(e.audioPlayer.src=l.currentAudioUrl,e.audioPlayer.load(),e.audioPlayer.play()),I(),M(n)}async function u(i){for(let n=i;n<l.onlineSongs.length;n++)try{await S(n);return}catch(t){console.warn(`第 ${n+1} 首 (${l.onlineSongs[n].name}) 尝试失败，跳过...`,t?.message??t)}e.lyrics&&(e.lyrics.innerHTML="<div>抱歉，当前列表中的歌曲均无法播放。</div>")}function A(){e.playlist&&(e.playlist.innerHTML=l.audioFiles.map((i,n)=>`<div id="track-item-${n}" onclick="playAudio(${n})">${i.name}</div>`).join("")||"<div>请选择本地音乐</div>")}function w(){if(!e.playlist)return;const i=e.playlist.querySelectorAll("div");let n=null;i.forEach((t,r)=>{const s=t,a=r===l.currentTrackIndex;s.classList.toggle("current",a),a&&(n=s)}),n&&n.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})}function I(){l.lyricsData=[],l.currentLyricLine=-1,e.lyrics&&(e.lyrics.innerHTML="<div>...</div>")}async function M(i){const n=i.name.split(".").slice(0,-1).join("."),t=l.lyricsFiles[n];if(t){const r=new FileReader;r.onload=s=>m(String(s.target?.result??"")),r.readAsText(t)}else $(i)}function $(i){jsmediatags.read(i,{onSuccess:n=>{const t=n.tags.USLT?.data??n.tags.SYLT?.data??n.tags.lyrics;t?m(t):e.lyrics&&(e.lyrics.innerHTML="<div>未找到任何歌词。</div>")},onError:()=>{e.lyrics&&(e.lyrics.innerHTML="<div>读取内嵌歌词失败。</div>")}})}function D(i){if(!i)return[];const n=i.split(`
`),t=[],r=/\[(\d{2}):(\d{2})[.:](\d{2,3})\]/g;for(const s of n){const a=s.replace(r,"").trim();if(a){let o;for(r.lastIndex=0;(o=r.exec(s))!==null;){const f=parseInt(o[1],10),b=parseInt(o[2],10),k=parseInt(o[3].padEnd(3,"0"),10);t.push({time:f*60+b+k/1e3,text:a})}}}return t.sort((s,a)=>s.time-a.time)}function m(i){l.lyricsData=D(i),e.lyrics&&(l.lyricsData.length>0?e.lyrics.innerHTML=l.lyricsData.map((n,t)=>`<div id="lyric-line-${t}">${n.text}</div>`).join(""):e.lyrics.innerHTML=i.split(`
`).map(n=>`<div>${n||"&nbsp;"}</div>`).join("")),l.currentLyricLine=-1,B()}function B(){if(l.lyricsData.length===0||!e.audioPlayer||e.audioPlayer.paused)return;const i=e.audioPlayer.currentTime,n=l.lyricsData.findIndex((t,r)=>{const s=l.lyricsData[r+1];return i>=t.time&&(s?i<s.time:!0)});if(n!==-1&&n!==l.currentLyricLine){document.getElementById(`lyric-line-${l.currentLyricLine}`)?.classList.remove("current");const r=document.getElementById(`lyric-line-${n}`);r&&(r.classList.add("current"),e.lyrics?.offsetParent!==null&&r.scrollIntoView({behavior:"smooth",block:"center"})),l.currentLyricLine=n}}function T(i){let n=i.length,t;for(;n!==0;)t=Math.floor(Math.random()*n),n--,[i[n],i[t]]=[i[t],i[n]];return i}window.findAndPlayOnlineSong=u;window.playAudio=y;
