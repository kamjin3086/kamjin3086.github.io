const h="briaai/RMBG-1.4",p="bg-remover-downloaded";let i=null,c=null;async function _(l={},a){const{AutoModel:d,AutoProcessor:r,env:m}=window.transformers;m.allowLocalModels=!1;const s=localStorage.getItem(p)!=="true";if(i&&c)return{model:i,processor:c,isFirstDownload:!1};const o=a?t=>a({...t,isFirstDownload:s}):void 0;return[i,c]=await Promise.all([d.from_pretrained(h,{config:{model_type:"custom"},progress_callback:o}),r.from_pretrained(h,{config:{feature_extractor_type:"ImageFeatureExtractor",resample:2,...l},progress_callback:o})]),localStorage.setItem(p,"true"),{model:i,processor:c,isFirstDownload:s}}async function D(l,a={},d){const{RawImage:r}=window.transformers,{model:m,processor:s}=await _(a,d),o=URL.createObjectURL(l),t=await r.fromURL(o),{pixel_values:f}=await s(t),{output:v}=await m({input:f}),u=await r.fromTensor(v[0].mul(255).to("uint8")).resize(t.width,t.height),e=document.createElement("canvas");e.width=t.width,e.height=t.height;const g=e.getContext("2d");g.drawImage(await t.toCanvas(),0,0);const w=g.getImageData(0,0,e.width,e.height),L=a.threshold??128;for(let n=0;n<u.data.length;++n)w.data[4*n+3]=u.data[n]>L?255:0;return g.putImageData(w,0,0),URL.revokeObjectURL(o),e.toDataURL("image/png")}export{D as removeBackground};
